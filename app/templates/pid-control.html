<html>

<head>
    <title>PID Control</title>

    <meta name="viewport" content="width=device-width,initial-scale=1">

    <!-- Page Layout -->
    <link rel="stylesheet" href="static/css/main.css" media='screen and (min-width: 800px)' />
    <link rel="stylesheet" href="static/css/mobile-main.css" media='screen and (max-width: 800px)' />
    <link rel="stylesheet" href="static/css/nav.css" />

    <!-- Themes -->
    <link rel="stylesheet" href="static/css/themes/controls_theme.css" />

    <!-- Material Design Icons -->
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@5.8.55/css/materialdesignicons.min.css" rel="stylesheet">

    <link rel="stylesheet" href="static/css/icons.css" />

    <!-- jQuery -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"
        integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg=="
        crossorigin="anonymous">
        </script>

    <!-- Automation -->
    <script src="static/js/html_loader.js"></script>

    <!-- ApexCharts -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

    <!-- PID Control demo JS -->
    <script src="static/js/pid_control_demo.js"></script>
</head>

<body>
    <div class="page-container">
        <div data-include="minor-header"></div>

        <div class="lesson-center-container">
            <div class="lesson-scroller">

                <div class="section-title">
                    Introduction
                    <hr>
                </div>

                <p class="lesson-text">
                    Lorem ipsum dolor sit amet, consectetur adipiscing elit. In quis ultricies risus. Etiam fermentum
                    elit
                    ut ligula pulvinar ultricies. Nullam egestas sollicitudin tempus. Nam ac interdum mi. Morbi nec
                    purus
                    vel ligula malesuada sollicitudin. Vestibulum ante ipsum primis in faucibus orci luctus et ultrices
                    posuere cubilia curae; Sed odio augue, rutrum sed imperdiet ut, ornare vitae mi. Fusce ex mi,
                    pharetra
                    nec placerat vitae, pellentesque vel felis. Aenean efficitur vel risus nec pharetra. Pellentesque
                    hendrerit leo in dui sollicitudin auctor. Maecenas ac magna vitae ipsum faucibus interdum nec
                    eleifend
                    nibh.
                </p>

                <div class="section-title">
                    What is PID?
                    <hr>
                </div>

                <p class="lesson-text">
                    Lorem ipsum dolor sit amet, consectetur adipiscing elit. In quis ultricies risus. Etiam fermentum
                    elit
                    ut ligula pulvinar ultricies. Nullam egestas sollicitudin tempus. Nam ac interdum mi. Morbi nec
                    purus
                    vel ligula malesuada sollicitudin. Vestibulum ante ipsum primis in faucibus orci luctus et ultrices
                    posuere cubilia curae; Sed odio augue, rutrum sed imperdiet ut, ornare vitae mi. Fusce ex mi,
                    pharetra
                    nec placerat vitae, pellentesque vel felis. Aenean efficitur vel risus nec pharetra. Pellentesque
                    hendrerit leo in dui sollicitudin auctor. Maecenas ac magna vitae ipsum faucibus interdum nec
                    eleifend
                    nibh.
                </p>


                <!-- PID Control -->
                <div class="example-block">
                    <!-- <div class="lesson-img-frame">
                        <img src="/static/img/quadcopter-cad.png" class="lesson-gif"></img>
                    </div> -->
                    <div class="example-header">PID Control Demo</div>
                    <!-- <div class="lesson-authors">
                            Justin Kleiber
                        </div> -->
                    <br>
                    <div class="example-frame">
                        <div id="x-chart-p-control"></div>
                        <div id="u-chart-p-control"></div>

                        <button onclick="run_p_sim()">Go!</button>

                        <div class="lesson-summary">
                            P = Proportional

                            I = Integral

                            D = Derivative
                        </div>
                    </div>
                </div>

            </div>
            <div data-include="footer"></div>
        </div>
    </div>

    <script>
        // Constants
        let X_AXIS_RANGE = 10;
        let TIME_INTERVAL_MS = 250;
        let DATA_LENGTH = 20;

        // P-control example
        p_charts = pid_chart_generator("#x-chart-p-control", "#u-chart-p-control", TIME_INTERVAL_MS);
        x_chart_1 = p_charts[0];
        u_chart_1 = p_charts[1];
        x_chart_1.render();
        u_chart_1.render();

        var p_control_run = false;
        var p_control_reset = false;

        var p_charts_dict = {
            x_chart: x_chart_1,
            pid_chart: u_chart_1
        };

        // Example constants
        var p_x0 = 4;   // Initial condition
        var p_xt = 0.0; // Setpoint
        var p_Kp = 0.5; // Proportional gain
        var p_tf = 10;  // final sim time
        var p_dt = TIME_INTERVAL_MS / 1000;

        // Example data
        var p_sim_data = {
            t: 0,
            x: p_x0,
            setpoint: p_xt,
            Kp: 1,
            Ki: 0,
            Kd: 0,
            dt: p_dt,
            prev_error: 0,
            integrator: 0
        };
        var p_x_data = {
            series: []
        };
        var p_pid_data = {
            series: []
        };
        // reset to initialize
        example_reset(p_x_data, p_pid_data);
        console.log(p_x_data)

        function run_p_sim() {
            if (p_control_run) {
                p_control_reset = true;
            }
            p_control_run = true;
        }

        window.setInterval(function () {
            // If the P-control needs to be reset, reset it.
            if (p_control_reset) {
                example_reset(p_x_data, p_pid_data);
                p_sim_data.prev_error = 0;
                p_sim_data.integrator = 0;
                p_sim_data.t = 0;
                p_control_reset = false;
            }

            // If P-control example is running, manage it.
            if (p_control_run) {
                // Run the simulation
                pid_control_sim(p_x_data.series, p_pid_data.series, p_sim_data);

                // Update charts
                p_charts_dict.pid_chart.updateSeries(p_pid_data.series);
                p_charts_dict.x_chart.updateSeries(p_x_data.series);

                if (p_sim_data.t >= p_tf) {
                    p_control_run = false;
                }
            }


        }, TIME_INTERVAL_MS);
    </script>
</body>

</html>